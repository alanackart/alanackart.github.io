---
layout:     	post
title:      	C/Cpp Fork
categories: 	C/CPP
description:   	C/CPPå¤šè¿›ç¨‹
keywords: 		C/CPP, fork
topmost: true
---

C/CPPçš„forkæœºåˆ¶æ€»ç»“

# åºè¨€

ä¹‹å‰è™½ç„¶å¯¹Cçš„forkæœºåˆ¶æœ‰æ‰€äº†è§£ï¼Œ ä½†æ˜¯æ—¶é—´ä¸€é•¿å°±æœ‰ç‚¹å¿˜äº†ï¼Œç°åœ¨æ¥åšä¸ªæ€»ç»“ã€‚å…ˆæå‡ºä»¥ä¸‹ä¸€äº›é—®é¢˜ï¼š

- **Cä¸­return å’Œexitæœ‰ä½•ä¸åŒï¼Ÿ**

  return ä¼šè¿”å›åˆ°ä¸Šä¸€å±‚è°ƒç”¨çš„åœ°æ–¹ï¼Œ è€Œexitä¼šä½¿å¾—è¿›ç¨‹ç›´æ¥é€€å‡º

- C ä¸­çˆ¶è¿›ç¨‹forkå‡ºå­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹ï¼Œ å­è¿›ç¨‹å¦‚ä½•æ‰§è¡Œï¼Ÿ

  çˆ¶è¿›ç¨‹ï¼Œå­è¿›ç¨‹éƒ½ä¼šæ‰§è¡Œforkå‘½ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œ forkåœ¨çˆ¶è¿›ç¨‹ä¸­è¿”å›å­è¿›ç¨‹pid(åˆ›å»ºæˆåŠŸæ—¶)ï¼Œ åœ¨å­è¿›ç¨‹ä¸­è¿”å›0ï¼Œ å½“`fork() == 0`å­è¿›ç¨‹ä¸­ä½¿ç”¨return åï¼Œ å­è¿›ç¨‹å°±ä¼šä¸çˆ¶è¿›ç¨‹æ‰§è¡Œé™¤forké™å®š(ç”¨fork è°ƒç”¨æ§åˆ¶æ‰§è¡Œçš„ä»£ç )å¤–çš„ä»£ç ï¼Œ æ­¤æ—¶çš„æƒ…å†µéœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚ 

  å¯ä»¥é˜…è¯» fork è°ƒç”¨çš„åŸç†ã€‚

- Linxu ç¨‹åºçš„å­˜å‚¨ç©ºé—´å®‰æ’ï¼Ÿ

- Linux Forkè¿›ç¨‹æ—¶çš„COWæŠ€æœ¯ï¼Ÿçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„é€»è¾‘åœ°å€ï¼Œ ç‰©ç†åœ°å€ï¼Ÿ

- çˆ¶å­è¿›ç¨‹A, Bä½¿ç”¨ä¸åŒçš„ä¿¡å·å¤„ç†å‡½æ•° ä½†æ˜¯çˆ¶å­A,Bè¿›ç¨‹å…¬ç”¨åŒä¸€ä¸ªstatä¸ªå‚æ•°ï¼Œ å­è¿›ç¨‹Bé€€å‡º(è¢«kill)æ—¶ï¼Œ çˆ¶è¿›ç¨‹Aä¹Ÿé€€å‡ºï¼Œï¼ˆç¨‹åºç»“æ„main ->fork A, A fork Bï¼‰, **æœªè§£ä¹‹è°œ**ğŸ˜‚ï¼Œ å¯ä»¥å®ç°ä¸€ä¸ªè¿™æ ·çš„ç¨‹åºï¼Œ é‡ç°ä¸€ä¸‹ï¼Œ äº†è§£ä¸‹statå‚æ•°çš„ä½œç”¨ï¼Œ [é˜…è¯»èµ„æ–™ï¼Œ wait/waitpidå‡½æ•°](https://www.twblogs.net/a/5c2e2724bd9eee35b3a48c59)





# test codeï¼š

```cpp
#include <stdio.h> 
#include <sys/types.h> 
#include <unistd.h> 
#include <signal.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
pid_t          pid;
int            restart_flag = 0;
int data1 = -99;
void sig_chld(int signo)
{
    pid_t   pid;
    int     stat;
    while((pid = waitpid(-1, &stat, WNOHANG)) > 0)
    {
        printf("pid:%ld crash, caught signal:%d\n",pid, signo);
        restart_flag = 1;    
    }
       
    return;
}
  
void child_func(){ 
	printf("child_func,  pid:%ld, ppid:%ld, data1=%d\n", getpid(), getppid(), data1);
        sleep(1);
	exit(0);
} 


int main() 
{
    restart_flag = 0; 
    int data_share_test = -99;
    if((pid = fork()) < 0)  
        return -1;
    else if(pid == 0){
        child_func();
    }
    signal(SIGCHLD, sig_chld);
    while(1){
        if(restart_flag == 1){
             if((pid = fork()) < 0) 
                return -1;
            else if(pid == 0)
            {
                 child_func();
            }
            restart_flag = 0; 
        }
	printf("pid:%ld, ppid:%ld, data1=%d\n", getpid(), getppid(), data1);
	data1++;
        sleep(3); 
    } 
    return 0; 
} 

```

